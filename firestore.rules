rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /vakis/{vakiId}/items/{itemId} {
      // Permitimos lectura pública para evitar el error "Missing or insufficient permissions" en la consulta de la colección.
      // Firestore NO filtra automáticamente los resultados basados en las reglas; si un solo documento
      // viola la regla, la consulta falla por completo. La expiración visual la maneja el componente React.
      allow read: if true;
      
      // Solo permite crear si el tiempo de expiración es razonable (máx 24h)
      allow create: if request.resource.data.expiresAt != null && 
                    request.resource.data.expiresAt <= request.time + duration.value(24, 'h');
      
      // Solo permite editar/borrar si no ha expirado
      allow update, delete: if resource != null && 
                            (resource.data.expiresAt == null || resource.data.expiresAt > request.time);
    }
  }
}
